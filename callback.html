<html>
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js">
    </script>
</head>
<body>
<a id="download"><h1>CallBack</h1></a>
<h2 id="show"></h2>
<script>

   var playlists = [];
   var songs = [];
   var goThrough = 0;
   var userId = "";

            var query = window.location.href.split("#")[1];
            console.log(query);

            if (query.includes("denied"))
            {
                console.log("end");

            }else {
                breakDownQuery(query);
            }

            function breakDownQuery(query) {
                partsQuery = {};

                var parts = query.split('&');
                for (var i = 0; i < parts.length; i++) {
                    splitOn = parts[i].split('=');
                    partsQuery[splitOn[0]] = splitOn[1];
                }
                console.log(partsQuery);

                document.getElementById("show").innerHTML = query;

                $.ajax({
                    url: 'https://api.spotify.com/v1/me',
                    headers: {
                        'Authorization': "Bearer " + partsQuery["access_token"]
                    },
                    success: function(response) {
                        console.log(response);
                        userId = response['id']
                        return ;
                    }
                });
            }

            function populatePlaylist(offSet){

                $.ajax({
                    url: 'https://api.spotify.com/v1/me/playlists?offset='+offSet+'&limit=20',
                    headers: {
                        'Authorization': "Bearer " + partsQuery["access_token"]
                    },
                    success: function(response) {
                        console.log(response);
                        var flipThrough = response["items"].length;
                        for (var i =0; i < flipThrough; i++){
                            playlists.push(response["items"][i]);
                            goThrough++;
                        }

                        if(goThrough < response["total"]){
                            populatePlaylist(goThrough);
                        }else{
                            displayPlayLists();
                            return;
                        }

                        console.log(playlists);
                    }
                });
            }

            function displayPlayLists(){
                var tble = document.createElement("TABLE");
                tble.setAttribute("id", "playlists");


                for (var i =0; i < goThrough; i++) {
                    console.log(i);
                    var y = document.createElement("TR");
                    y.setAttribute("id", i);
                    y.style.backgroundColor= "#AAAAAA";
                    y.onclick = tracks;
                    if (i % 2 == 0){
                        y.style.backgroundColor= "#EEEEEE";
                    }
                    tble.appendChild(y);
                    var z = document.createElement("TD");
                    var t1  = document.createTextNode(i+1);
                    var t2 = document.createElement("img");
                    t2.src = playlists[i]['images'][0]['url'];
                    t2.height = 100;
                    t2.width = 100;
                    var t3 = document.createElement("h3");
                    t3.innerHTML = (playlists[i]['name']);
                    t3.verticalAlign = "middle";

                    //z.appendChild(t1);
                    z.appendChild(t2);
                    z.appendChild(t3);
                    y.appendChild(z);
                }


                document.body.appendChild(tble);
                document.getElementById("show").innerHTML = "Click a playlist";
            }

            function tracks(){
                var playlistNum = this.id;
                document.getElementById("show").innerHTML = playlistNum;
                var playlistID = playlists[playlistNum]['id'];
                var urlUse = playlists[playlistNum]['href'];
                goThrough = 0;
                songs = [];
                console.log(urlUse);
                trackPopulate(urlUse,goThrough);
            }

            function trackPopulate(urlUse,offSet){
                $.ajax({
                    url: urlUse,
                    headers: {
                        'Authorization': "Bearer " + partsQuery["access_token"]
                    },
                    success: function(response) {
                        console.log(response);
                        var total = 0;
                        try {
                            total = response["tracks"]["total"];
                            var flipThrough = response["tracks"]["items"].length;
                            for (var i = 0; i < flipThrough; i++) {
                                songs.push(response["tracks"]["items"][i]);
                                goThrough++;
                            }
                        }catch (e){
                            console.log(e);
                            total = response["total"];
                            var flipThrough = response["items"].length;
                            for (var i = 0; i < flipThrough; i++) {
                                songs.push(response["items"][i]);
                                goThrough++;
                            }
                        }

                        if(goThrough < total){
                            var next = "";
                            try{
                                next = response["tracks"]["next"];
                            }catch (e){
                                console.log(e);
                                next = response["next"];
                            }
                            trackPopulate(next,goThrough);
                        }else{
                            displaySongs();
                            return;
                        }

                        console.log(songs);
                    }
                });
            }

   function displaySongs(){
       var tble = document.getElementById("playlists");
       document.body.removeChild(tble);

       console.log(songs);

       document.getElementById("show").innerHTML = songs.length;
       createFile(songs);
   }

   function playListAdd(name, artist, composer, album){
       var n = name;
       var a = artist;
       var c = composer;
       var aa  = album;
    if (!name){
        n = "	";
    }
    if (!artist){
        a = "	";
    }
    if (!composer){
        c = "	";
    }
    if (!album){
        aa = "	";
    }

    return "\n"+n+"	"+a+"	"+c+"	"+aa+"								0	0	0	0	0	0	0					256	44100		Apple Music AAC audio file							";

   }
   var textFile
   function createFile(songs){
       var playListDL = [];
       playListDL.push("Name	Artist	Composer	Album	Grouping	Work	Movement Number	Movement Count	Movement Name	Genre	Size	Time	Disc Number	Disc Count	Track Number	Track Count	Year	Date Modified	Date Added	Bit Rate	Sample Rate	Volume Adjustment	Kind	Equalizer	Comments	Plays	Last Played	Skips	Last Skipped	My Rating	Location");

               $.ajax({
                   url: "https://itunes.apple.com/search?term=forever+drake&country=CA&media=music&limit=1&lang=en_us&explicit=Yes",

                   success: function(response) {
                       console.log(response);
                   }
               });
       for (var i = 0; i < songs.length; i++){
            console.log (songs[i]["track"]["name"]);
           console.log (songs[i]["track"]["name"]);
       }
       playListDL.push(playListAdd("One Minute","Isaiah Dreads", "Thomas Broderick, Anthony Bamgboye & Isaiah Hamilton","Lone Wolf - EP"));

       var blob = new Blob(playListDL, {type: "text/plain;charset=utf-8"});
       textFile = window.URL.createObjectURL(blob);
       var link = document.getElementById('download');
       link.href = textFile;
       link.setAttribute("download","test5.txt");
   }

   populatePlaylist(0);





</script>
</body>
</html>